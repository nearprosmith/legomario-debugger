<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LEGO Mario Debugger</title>
  <script type="application/javascript" src="./bluejelly/src/bluejelly.js"></script>
</head>
<body>
<button id="scan" onclick="scan()">Scan</button>
<button id="connect" onclick="connect()">Connect</button>
<button id="regnotify" onclick="reg_notify()">Reg Notify</button><br />
<input type="text" id="op" style="width:20rem;" /><button id="write" onclick="write_data()">Write</button><br />
<textarea id="log" style="width:50rem;height:50rem;">

</textarea>

<script>
  const ble = new BlueJelly();

  window.onload = () => {
    ble.setUUID("LEGOMario", "00001623-1212-efde-1623-785feabcd123", "00001624-1212-efde-1623-785feabcd123");
  };

  ble.onScan = (uuid) => {
    console.log(`Scan ${uid}`);
  }
  ble.onConnectGATT = (uuid) => {
    console.log(`Connect ${uuid}`);
    document.getElementById("log").value += "Connect LEGO Mario!\n-------------------\n";
  }
  ble.onStartNotify = (uuid) => {
    console.log(`Start Notify ${uuid}`);
  }
  ble.onRead = (data,uuid) => {
    console.log(`Read ${uuid}`);
    console.log(data);
    document.getElementById("log").value += '0x'+buf2hex(data.buffer).match(/.{2}/g).join(' ') + "\n";
  }
  ble.onWrite = (uuid) => {
    document.getElementById("log").value += `Write: ${document.getElementById('op').value}\n`;
  }

  const connect = () => {
    ble.connectGATT("LEGOMario");
  };
  const scan = () =>{
    ble.scan("LEGOMario");
  }
  const reg_notify = () => {
    ble.startNotify("LEGOMario");
  }
  const write_data = () => {
    const op = document.getElementById('op').value;
    ble.write("LEGOMario",str2data(op));
  }

  function buf2hex(buffer) { // buffer is an ArrayBuffer
    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
  }
  function str2data(str){
    const segments = str.match(/.{2}/g);
    let code = new Array();
    for (let i = 0; i < segments.length; i++) {
      code.push(parseInt(`0x${segments[i]}`));
    }
    return code;
  }
</script>
</body>
</html>
