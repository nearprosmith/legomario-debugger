<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LEGO Mario Debugger</title>
  <link rel="stylesheet" href="./css/style.css" media="all"/>
  <script type="application/javascript" src="./bluejelly/src/bluejelly.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174332879-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-174332879-1');
  </script>
  <script src="./node_modules/vue/dist/vue.min.js" type="application/javascript"></script>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="container">
      <h1><img src="img/logo.png" alt="LEGO SUPER MARIO DEBUGGER" style="max-height:120px;"/></h1>
    </div>
  </div>
  <hr/>
  <section>
    <div class="container">
      <div class="columns">
        <div class="column is-one-third">
          <div style="padding:1em 0;">
            <button id="scan" class="button is-outlined">Scan</button>
            <button id="connect" class="button is-outlined">Connect</button>
            <button id="regnotify" class="button is-info">Reg Notify</button>
          </div>
          <div class="field has-addons">
            <div class="control">
              <input type="text" id="op" class="input is-medium is-inline-block" style="width:16rem"
                     placeholder="Input hex code"/>
            </div>
            <div class="control">
              <button id="write" class="button is-medium">Write</button>
            </div>
          </div>
        </div>
        <div class="column">
          <h3 class="is-size-4">LEGO Mario Status</h3>
        </div>
      </div>
      <hr/>
      <textarea id="log" style="height:25rem;" class="textarea"></textarea>
    </div>
  </section>
</div>
<script type="module">
  import LEGOMarioMessage from './js/legomario.js';

  const ble = new BlueJelly();
  window.onload = () => {
    ble.setUUID("LEGOMario", "00001623-1212-efde-1623-785feabcd123", "00001624-1212-efde-1623-785feabcd123");
    document.getElementById('regnotify').addEventListener('click', () => {
      ble.startNotify("LEGOMario");
    });
    document.getElementById('scan').addEventListener('click', () => {
      ble.scan("LEGOMario");
    });
    document.getElementById('connect').addEventListener('click', () => {
      ble.connectGATT("LEGOMario");
    });
    document.getElementById('write').addEventListener('click', () => {
      const op = document.getElementById('op').value;
      ble.write("LEGOMario", str2data(op));
    });
  };

  ble.onScan = (uuid) => {
    console.log(`Scan ${uid}`);
  }
  ble.onConnectGATT = (uuid) => {
    console.log(`Connect ${uuid}`);
    document.getElementById("log").value += "Connect LEGO Mario!\n-------------------\n";
  }
  ble.onStartNotify = (uuid) => {
    console.log(`Start Notify ${uuid}`);
  }
  ble.onRead = (data, uuid) => {
    // console.log(data);
    // console.log(new Uint8Array(str2data("0f0004000147000000002001000000")) == new Uint8Array(data.buffer).toString());
    // console.log(btoa(data.buffer) );
    // if(btoa(data.buffer) === btoa(new Uint8Array(...['0x'])))
    const message = LEGOMarioMessage.decode(data.buffer);
    console.log(message.messageType, message.data);
    document.getElementById("log").value += '0x' + buf2hex(data.buffer).match(/.{2}/g).join(' ') + "\n";
  }


  const write_data = () => {
    const op = document.getElementById('op').value;
    ble.write("LEGOMario", str2data(op));
  }

  function buf2hex(buffer) { // buffer is an ArrayBuffer
    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
  }

  function str2data(str) {
    const segments = str.match(/.{2}/g);
    let code = new Array();
    for (let i = 0; i < segments.length; i++) {
      code.push(parseInt(`0x${segments[i]}`));
    }
    return code;
  }
</script>
</body>
</html>
